<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Online</title>
    <link rel="stylesheet" href="../css/estilosTienda.css">
</head>
<body>

    <div>
        <h1>Tecnolog√≠a</h1>

        <div>
            <div onclick="mostrarWishlist()">
                ‚ù§Ô∏è
                <span id="wishlist-contador">0</span>
            </div>

            <div onclick="mostrarCarrito()">
                üõí
                <span id="carrito-contador">0</span>
            </div>
        </div>
    </div>

    <div>
        <div id="productos-container"></div>
    </div>

    <!-- Modal Carrito -->
    <div id="modal-carrito">
        <div>
            <div>
                <h2>üõí Mi Carrito</h2>
                <button onclick="cerrarModal('modal-carrito')">√ó</button>
            </div>

            <div id="mensaje-carrito"></div>
            <div id="carrito-items"></div>
            <div id="total-carrito">
                <p id="subtotal"></p>
                <p id="iva"></p>
                <h3 id="total-final"></h3>
            </div>

            <button onclick="finalizarCompra()">Finalizar Compra</button>
        </div>
    </div>

    <!-- Modal Wishlist -->
    <div id="modal-wishlist">
        <div>
            <div>
                <h2>‚ù§Ô∏è Mi Wishlist</h2>
                <button onclick="cerrarModal('modal-wishlist')">√ó</button>
            </div>

            <div id="wishlist-items"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "http://localhost:3000";
    </script>

    <script src="../js/carritoManager.js"></script>
    <script src="../js/wishlistManager.js"></script>

    <script>

async function cargarProductos() {
    const container = document.getElementById("productos-container");
    
    try {
        const respuesta = await fetch(`${API_BASE_URL}/api/productos`);
        const productos = await respuesta.json();

        container.innerHTML = "";

        productos.forEach(prod => {
            container.innerHTML += `
                <div>
                    <img src="${API_BASE_URL}/uploads/${prod.imagen}" 
                         alt="${prod.nombre}"
                         onerror="this.src='https://via.placeholder.com/150?text=Sin+Imagen'">

                    <h3>${prod.nombre}</h3>
                    <p>${prod.descripcion}</p>
                    <p>$${prod.precio}</p>

                    <div>
                        <button onclick='agregarAlCarrito(${JSON.stringify(prod)})'>
                            Agregar
                        </button>

                        <button 
                            data-producto-id="${prod.id}"
                            onclick='toggleWishlist(${JSON.stringify(prod)})'>
                            ü§ç
                        </button>
                    </div>
                </div>
            `;
        });

    } catch (error) {
        console.error("Error al cargar productos:", error);
        container.innerHTML = `<p>Error al cargar los productos.</p>`;
    }
}

function agregarAlCarrito(producto) {
    carritoManager.agregarProducto(producto);
}

function toggleWishlist(producto) {
    wishlistManager.toggleProducto(producto);

    const boton = document.querySelector(`[data-producto-id="${producto.id}"]`);
    boton.textContent = wishlistManager.estaEnWishlist(producto.id) ? "‚ù§Ô∏è" : "ü§ç";

    actualizarContadores();
}

function mostrarCarrito() {
    const carrito = carritoManager.obtenerCarrito();
    const container = document.getElementById('carrito-items');

    if (carrito.length === 0) {
        container.innerHTML = '<p>El carrito est√° vac√≠o</p>';
        document.getElementById('subtotal').textContent = '';
        document.getElementById('iva').textContent = '';
        document.getElementById('total-final').textContent = '';
    } else {
        container.innerHTML = carrito.map(item => `
            <div>
                <img src="${API_BASE_URL}/uploads/${item.imagen}"
                     alt="${item.nombre}"
                     onerror="this.src='https://placehold.co/80x80?text=No+Img'">

                <div>
                    <h4>${item.nombre}</h4>
                    <p>$${Number(item.precio).toFixed(2)} c/u</p>

                    <div>
                        <button onclick="cambiarCantidad(${item.id}, ${item.cantidad - 1})">-</button>
                        <span>${item.cantidad}</span>
                        <button onclick="cambiarCantidad(${item.id}, ${item.cantidad + 1})">+</button>
                        <button onclick="eliminarDelCarrito(${item.id})">üóëÔ∏è</button>
                    </div>
                </div>

                <div>
                    $${(Number(item.precio) * item.cantidad).toFixed(2)}
                </div>
            </div>
        `).join('');

        // CALCULOS
        const subtotal = carritoManager.calcularTotal();
        const iva = subtotal * 0.16;
        const totalFinal = subtotal + iva;

        // MOSTRAR LOS RESULTADOS
        document.getElementById('subtotal').textContent = `Subtotal: $${subtotal.toFixed(2)}`;
        document.getElementById('iva').textContent = `IVA (16%): $${iva.toFixed(2)}`;
        document.getElementById('total-final').textContent = `Total a pagar: $${totalFinal.toFixed(2)}`;
    }

    document.getElementById('modal-carrito').style.display = "block";
}


function mostrarWishlist() {
    const wishlist = wishlistManager.obtenerWishlist();
    const container = document.getElementById('wishlist-items');

    if (wishlist.length === 0) {
        container.innerHTML = '<p>El wishlist est√° vac√≠o</p>';
    } else {
        container.innerHTML = wishlist.map(item => `
            <div>
                <img src="${API_BASE_URL}/uploads/${item.imagen}"
                     alt="${item.nombre}"
                     onerror="this.src='https://placehold.co/80x80?text=No+Img'">

                <div>
                    <h4>${item.nombre}</h4>
                    <p>$${Number(item.precio).toFixed(2)}</p>

                    <button onclick="moverAlCarrito(${item.id})">Mover al Carrito</button>
                </div>

                <button onclick="eliminarDelWishlist(${item.id})">
                    üóëÔ∏è
                </button>
            </div>
        `).join('');
    }

    document.getElementById('modal-wishlist').style.display = "block";
}

function cambiarCantidad(id, nuevaCantidad) {
    carritoManager.actualizarCantidad(id, nuevaCantidad);
    mostrarCarrito();
}

function eliminarDelCarrito(id) {
    carritoManager.eliminarProducto(id);
    mostrarCarrito();
}

function eliminarDelWishlist(id) {
    wishlistManager.eliminarProducto(id);
    mostrarWishlist();
}

function moverAlCarrito(id) {
    wishlistManager.moverAlCarrito(id);
    mostrarWishlist();
    actualizarContadores();
}

function finalizarCompra() {
    const carrito = carritoManager.obtenerCarrito();
    console.log("FINALIZAR COMPRA EJECUTADO");

    if (carrito.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
    }

    cerrarModal('modal-carrito');

    window.location.href = "checkout.html";
}

function cerrarModal(modalId) {
    document.getElementById(modalId).style.display = "none";
}

function actualizarContadores() {
    carritoManager.actualizarUI();
    wishlistManager.actualizarUI();
}

// Cerrar modales al hacer clic fuera
window.onclick = function(event) {
    if (event.target.id === "modal-carrito" || event.target.id === "modal-wishlist") {
        event.target.style.display = "none";
    }
}

cargarProductos();
actualizarContadores();

</script>

</body>
</html>
